<!DOCTYPE html>
<html>
<head>
  <title>DoodleBlox</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    .section { display: none; margin-top: 20px; }
    img { max-width: 100px; display: block; }
    input, button { margin: 5px 0; display: block; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h2>DoodleBlox</h2>

  <div id="auth-section">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
  </div>

  <div id="app-section" class="section">
    <h3>Upload DoodleGames</h3>
    <input type="text" id="gameTitle" placeholder="DoodleGame Title">
    <input type="file" id="gameIcon">
    <button onclick="uploadGame()">Upload DoodleGame</button>

    <h3>Your DoodleGames</h3>
    <div id="myGames"></div>

    <h3>Send DoodleFriend Request</h3>
    <input type="email" id="friendEmail" placeholder="Friend's email">
    <button onclick="sendFriendRequest()">Send DoodleFriend Request</button>

    <h3>Incoming DoodleFriend Requests</h3>
    <div id="requests"></div>

    <h3>Your DoodleFriends' DoodleGames</h3>
    <div id="friendGames"></div>

    <button onclick="signOut()">Sign Out</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLq-MBX_AXTWo6ksi1690z5Ecxak_ABHw",
      authDomain: "doodleblox-18ab9.firebaseapp.com",
      databaseURL: "https://doodleblox-18ab9-default-rtdb.firebaseio.com",
      projectId: "doodleblox-18ab9",
      storageBucket: "doodleblox-18ab9.firebasestorage.app",
      messagingSenderId: "1021914943421",
      appId: "1:1021914943421:web:a9f1a92f2d7c650882ccd4",
      measurementId: "G-S54GF572F3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUserEmailSafe = "";

    function encodeEmail(email) {
      return email.replace(/\./g, '_');
    }

    function signUp() {
      auth.createUserWithEmailAndPassword(
        email.value, password.value
      ).catch(e => alert(e.message));
    }

    function signIn() {
      auth.signInWithEmailAndPassword(
        email.value, password.value
      ).catch(e => alert(e.message));
    }

    function signOut() {
      auth.signOut();
      location.reload();
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('app-section').style.display = 'block';
        currentUserEmailSafe = encodeEmail(user.email);
        loadMyGames();
        loadRequests();
        loadFriendGames();
      }
    });

    function uploadGame() {
      const title = gameTitle.value.trim();
      const file = gameIcon.files[0];
      if (!title || !file) return alert("Fill all fields!");

      const reader = new FileReader();
      reader.onload = function () {
        const base64 = reader.result;
        const game = { title, icon: base64 };
        const ref = db.ref("games/" + currentUserEmailSafe);
        ref.push(game).then(() => {
          gameTitle.value = '';
          gameIcon.value = '';
          loadMyGames();
        });
      };
      reader.readAsDataURL(file);
    }

    function loadMyGames() {
      const ref = db.ref("games/" + currentUserEmailSafe);
      ref.once('value', snap => {
        const container = document.getElementById("myGames");
        container.innerHTML = '';
        snap.forEach(child => {
          const data = child.val();
          container.innerHTML += `<p>${data.title}</p><img src="${data.icon}">`;
        });
      });
    }

    function sendFriendRequest() {
      const toEmail = friendEmail.value.trim();
      if (!toEmail) return;
      const safeTo = encodeEmail(toEmail);
      db.ref("friendRequests/" + safeTo + "/" + currentUserEmailSafe).set(true);
      alert("Request sent!");
    }

    function loadRequests() {
      const ref = db.ref("friendRequests/" + currentUserEmailSafe);
      ref.on('value', snap => {
        const box = document.getElementById("requests");
        box.innerHTML = '';
        snap.forEach(child => {
          const sender = child.key;
          box.innerHTML += `<div>${sender} <button onclick="acceptFriend('${sender}')">Accept</button></div>`;
        });
      });
    }

    function acceptFriend(sender) {
      db.ref("friends/" + currentUserEmailSafe + "/" + sender).set(true);
      db.ref("friends/" + sender + "/" + currentUserEmailSafe).set(true);
      db.ref("friendRequests/" + currentUserEmailSafe + "/" + sender).remove();
      loadFriendGames();
    }

    function loadFriendGames() {
      db.ref("friends/" + currentUserEmailSafe).once('value', snap => {
        const container = document.getElementById("friendGames");
        container.innerHTML = '';
        snap.forEach(friend => {
          const friendKey = friend.key;
          db.ref("games/" + friendKey).once('value', gameSnap => {
            gameSnap.forEach(child => {
              const game = child.val();
              container.innerHTML += `<p>${friendKey}: ${game.title}</p><img src="${game.icon}">`;
            });
          });
        });
      });
    }
  </script>
</body>
</html>