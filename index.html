<!DOCTYPE html>
<html>
<head>
  <title>DoodleBlox</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #authUI, #mainUI { display: none; }
    img { width: 100px; height: 100px; object-fit: cover; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<h2>DoodleBlox</h2>
<div id="authUI">
  <input placeholder="Email" id="email"><br>
  <input placeholder="Password" id="password" type="password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Sign In</button>
  <button onclick="resetPass()">Reset Password</button>
</div>

<div id="mainUI">
  <p>Welcome, <span id="userEmail"></span> | <button onclick="logout()">Logout</button></p>
  <p>DoodleBux: <span id="doodlebux">0</span></p>

  <h3>DoodleFriends</h3>
  <input id="friendId" placeholder="Enter UID to friend">
  <button onclick="sendRequest()">Send Request</button>
  <div id="requests"></div>

  <h3>Upload DoodleGames</h3>
  <input id="gameTitle" placeholder="Game title"><br>
  <input id="gameIcon" type="file" accept="image/*"><br>
  <button onclick="uploadGame()">Upload DoodleGame</button>

  <h3>DoodleGames</h3>
  <div id="gameList"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBLq-MBX_AXTWo6ksi1690z5Ecxak_ABHw",
  authDomain: "doodleblox-18ab9.firebaseapp.com",
  databaseURL: "https://doodleblox-18ab9-default-rtdb.firebaseio.com",
  projectId: "doodleblox-18ab9",
  appId: "1:1021914943421:web:a9f1a92f2d7c650882ccd4"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

function signUp() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(userCred => {
      userCred.user.sendEmailVerification().then(() => {
        alert("Check your email for a verification link.");
      });
    })
    .catch(err => alert(err.message));
}

function signIn() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email, pass)
    .catch(err => alert(err.message));
}

function resetPass() {
  const email = document.getElementById("email").value;
  auth.sendPasswordResetEmail(email)
    .then(() => alert("Reset email sent."))
    .catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

auth.onAuthStateChanged(user => {
  if (user) {
    if (!user.emailVerified) {
      alert("Please verify your email first.");
      auth.signOut();
      return;
    }

    document.getElementById("authUI").style.display = "none";
    document.getElementById("mainUI").style.display = "block";
    document.getElementById("userEmail").textContent = user.email;

    // Daily DoodleBux tracking
    const today = new Date().toDateString();
    db.ref("lastLogin/" + user.uid).once("value").then(snap => {
      if (snap.val() !== today) {
        db.ref("lastLogin/" + user.uid).set(today);
        db.ref("bux/" + user.uid).once("value").then(buxSnap => {
          let val = buxSnap.val();
          if (typeof val === 'object') {
            val = parseInt(val?.value || 0);
          } else {
            val = parseInt(val || 0);
          }
          db.ref("bux/" + user.uid).set(val + 1);
        });
      }
    });

    // DoodleBux Display
    db.ref("bux/" + user.uid).on("value", snap => {
      let val = snap.val();
      if (typeof val === 'object') {
        val = parseInt(val?.value || 0);
      }
      document.getElementById("doodlebux").textContent = val || 0;
    });

    loadRequests();
    loadGames();
  } else {
    document.getElementById("authUI").style.display = "block";
    document.getElementById("mainUI").style.display = "none";
  }
});

function sendRequest() {
  const toId = document.getElementById("friendId").value;
  const fromId = auth.currentUser.uid;
  if (toId === fromId) return alert("You can't add yourself.");
  db.ref("requests/" + toId + "/" + fromId).set(true);
  alert("Friend request sent!");
}

function loadRequests() {
  const uid = auth.currentUser.uid;
  const container = document.getElementById("requests");
  container.innerHTML = "<h4>Friend Requests</h4>";

  db.ref("requests/" + uid).on("value", snap => {
    container.innerHTML = "<h4>Friend Requests</h4>";
    snap.forEach(child => {
      const from = child.key;
      const btn = document.createElement("button");
      btn.textContent = "Accept " + from;
      btn.onclick = () => {
        db.ref("friends/" + uid + "/" + from).set(true);
        db.ref("friends/" + from + "/" + uid).set(true);
        db.ref("requests/" + uid + "/" + from).remove();
        btn.remove();
        loadGames();
      };
      container.appendChild(btn);
    });
  });
}

function uploadGame() {
  const title = document.getElementById("gameTitle").value;
  const file = document.getElementById("gameIcon").files[0];
  if (!title || !file) return alert("Add a title and image!");

  const reader = new FileReader();
  reader.onload = e => {
    const icon = e.target.result;
    const uid = auth.currentUser.uid;
    db.ref("games/" + uid).push({ title, icon });
    alert("DoodleGame uploaded!");
    loadGames();
  };
  reader.readAsDataURL(file);
}

function loadGames() {
  const uid = auth.currentUser.uid;
  const list = document.getElementById("gameList");
  list.innerHTML = "<h4>Your DoodleGames + DoodleFriends</h4>";

  // Your games
  db.ref("games/" + uid).once("value").then(snap => {
    snap.forEach(child => {
      const game = child.val();
      const div = document.createElement("div");
      div.innerHTML = `<strong>${game.title}</strong><br><img src="${game.icon}">`;
      list.appendChild(div);
    });
  });

  // Friends' games
  db.ref("friends/" + uid).once("value").then(friendSnap => {
    const friends = Object.keys(friendSnap.val() || {});
    friends.forEach(fid => {
      db.ref("games/" + fid).once("value").then(gamesSnap => {
        gamesSnap.forEach(child => {
          const game = child.val();
          const div = document.createElement("div");
          div.innerHTML = `<strong>${game.title} (Friend)</strong><br><img src="${game.icon}">`;
          list.appendChild(div);
        });
      });
    });
  });
}
</script>
</body>
</html>