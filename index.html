<!DOCTYPE html>
<html>
<head>
  <title>DoodleBlox</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    img { width: 64px; height: 64px; object-fit: contain; }
    #authSection, #mainSection { display: none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyBLq-MBX_AXTWo6ksi1690z5Ecxak_ABHw",
      authDomain: "doodleblox-18ab9.firebaseapp.com",
      databaseURL: "https://doodleblox-18ab9-default-rtdb.firebaseio.com",
      projectId: "doodleblox-18ab9",
      appId: "1:1021914943421:web:a9f1a92f2d7c650882ccd4"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUser = null;
    let uploadedIconBase64 = "";

    window.onload = function() {
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          currentUser = user;
          document.getElementById("authSection").style.display = "none";
          document.getElementById("mainSection").style.display = "block";
          document.getElementById("userEmail").innerText = user.email;
          firebase.database().ref("emailToUid/" + btoa(user.email)).set(user.uid);
          firebase.database().ref("users/" + user.uid).set({ email: user.email });
          updateDoodleBux();
          loadGames();
          loadFriends();
        } else {
          document.getElementById("authSection").style.display = "block";
          document.getElementById("mainSection").style.display = "none";
        }
      });
    };

    function signUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().createUserWithEmailAndPassword(email, password).catch(alert);
    }

    function signIn() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password).catch(alert);
    }

    function resetPassword() {
      const email = document.getElementById("email").value;
      firebase.auth().sendPasswordResetEmail(email).then(() => alert("Email sent")).catch(alert);
    }

    function signOut() {
      firebase.auth().signOut();
    }

    function updateDoodleBux() {
      const userId = currentUser.uid;
      const today = new Date().toDateString();
      const ref = firebase.database().ref("users/" + userId);
      ref.once("value", snapshot => {
        const data = snapshot.val() || {};
        if (data.lastLogin !== today) {
          ref.update({ lastLogin: today, doodleBux: (data.doodleBux || 0) + 1 });
        }
      });
      ref.child("doodleBux").on("value", snap => {
        document.getElementById("doodleBux").innerText = snap.val() || 0;
      });
    }

    function uploadGame() {
      const title = document.getElementById("gameTitle").value;
      if (!title || !uploadedIconBase64) return alert("Title and icon required!");
      const userId = currentUser.uid;
      firebase.database().ref("games/" + userId).push({
        title: title,
        iconBase64: uploadedIconBase64
      });
      document.getElementById("gameTitle").value = "";
    }

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedIconBase64 = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function loadGames() {
      const userId = currentUser.uid;
      document.getElementById("gameList").innerHTML = "";

      firebase.database().ref("games/" + userId).on("child_added", snap => {
        const game = snap.val();
        const gameId = snap.key;
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${game.title}</strong><br>
          <img src="${game.iconBase64 || ""}"><br>
          <button onclick="deleteGame('${gameId}')">Delete</button><hr>
        `;
        document.getElementById("gameList").appendChild(div);
      });

      firebase.database().ref("friends/" + userId).on("child_added", snap => {
        const friendId = snap.key;
        firebase.database().ref("games/" + friendId).on("child_added", g => {
          const game = g.val();
          firebase.database().ref("users/" + friendId).once("value", userSnap => {
            const friendEmail = userSnap.val()?.email || "Unknown";
            const div = document.createElement("div");
            div.innerHTML = `
              <strong>${friendEmail}'s Game: ${game.title}</strong><br>
              <img src="${game.iconBase64 || ""}"><hr>
            `;
            document.getElementById("gameList").appendChild(div);
          });
        });
      });
    }

    function deleteGame(gameId) {
      const userId = currentUser.uid;
      firebase.database().ref("games/" + userId + "/" + gameId).remove();
      loadGames(); // refresh the list
    }

    function sendFriendRequest() {
      const targetEmail = document.getElementById("friendEmail").value;
      firebase.database().ref("emailToUid/" + btoa(targetEmail)).once("value", snap => {
        if (snap.exists()) {
          const targetUid = snap.val();
          firebase.database().ref("requests/" + targetUid + "/" + currentUser.uid).set(true);
          alert("Friend request sent");
        } else {
          alert("User not found");
        }
      });
    }

    function loadFriends() {
      const userId = currentUser.uid;
      document.getElementById("friendList").innerHTML = "";
      firebase.database().ref("friends/" + userId).on("child_added", snap => {
        const friendId = snap.key;
        firebase.database().ref("users/" + friendId).once("value", userSnap => {
          const email = userSnap.val()?.email || "Unknown";
          const p = document.createElement("p");
          p.innerText = email;
          document.getElementById("friendList").appendChild(p);
        });
      });

      const reqRef = firebase.database().ref("requests/" + userId);
      reqRef.on("child_added", snap => {
        const requesterId = snap.key;
        firebase.database().ref("users/" + requesterId).once("value", userSnap => {
          const email = userSnap.val()?.email || "Unknown";
          const btn = document.createElement("button");
          btn.innerText = "Accept " + email;
          btn.onclick = () => {
            firebase.database().ref("friends/" + userId + "/" + requesterId).set(true);
            firebase.database().ref("friends/" + requesterId + "/" + userId).set(true);
            firebase.database().ref("requests/" + userId + "/" + requesterId).remove();
            btn.remove();
          };
          document.getElementById("requests").appendChild(btn);
        });
      });
    }
  </script>
</head>
<body>
  <div id="authSection">
    <h2>DoodleBlox Login</h2>
    <input id="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
    <button onclick="resetPassword()">Reset Password</button>
  </div>
  <div id="mainSection">
    <h2>Welcome: <span id="userEmail"></span></h2>
    <p>DoodleBux: <span id="doodleBux">0</span></p>
    <button onclick="signOut()">Sign Out</button>

    <h3>Upload DoodleGames</h3>
    <input id="gameTitle" placeholder="Game Title"><br>
    <input type="file" accept="image/*" onchange="handleFile(event)"><br>
    <button onclick="uploadGame()">Upload DoodleGames</button>

    <h3>All Games</h3>
    <div id="gameList"></div>

    <h3>DoodleFriends</h3>
    <input id="friendEmail" placeholder="Friend's Email"><br>
    <button onclick="sendFriendRequest()">Send Request</button>
    <div id="requests"></div>
    <div id="friendList"></div>
  </div>
</body>
</html>