<!DOCTYPE html>
<html>
<head>
  <title>DoodleBlox</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #authUI, #mainUI { display: none; }
    img { width: 100px; height: 100px; object-fit: cover; display: block; margin-top: 4px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<h2>DoodleBlox</h2>

<div id="authUI">
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Sign In</button>
  <button onclick="resetPassword()">Reset Password</button>
</div>

<div id="mainUI">
  <p>Welcome <span id="userEmail"></span> | <button onclick="signOut()">Sign Out</button></p>
  <p>DoodleBux: <span id="doodleBux">0</span></p>

  <h3>DoodleFriends</h3>
  <ul id="friendsList"></ul>

  <h3>Friend Requests</h3>
  <ul id="friendRequestsList"></ul>

  <h3>DoodleGames</h3>
  <ul id="gamesList"></ul>

  <h3>Upload DoodleGames</h3>
  <input id="gameTitle" placeholder="Game Title"><br>
  <input type="file" id="gameIconInput" accept="image/*"><br>
  <button onclick="uploadGame()">Upload DoodleGame</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBLq-MBX_AXTWo6ksi1690z5Ecxak_ABHw",
    authDomain: "doodleblox-18ab9.firebaseapp.com",
    databaseURL: "https://doodleblox-18ab9-default-rtdb.firebaseio.com",
    projectId: "doodleblox-18ab9",
    appId: "1:1021914943421:web:a9f1a92f2d7c650882ccd4"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let uploadedIconBase64 = "";

  auth.onAuthStateChanged(user => {
    if (user) {
      if (user.email === "chdoodle15@gmail.com" || user.emailVerified) {
        document.getElementById("authUI").style.display = "none";
        document.getElementById("mainUI").style.display = "block";
        document.getElementById("userEmail").textContent = user.email;
        loadUserData(user.uid);
      } else {
        alert("Please verify your email.");
        auth.signOut();
      }
    } else {
      document.getElementById("authUI").style.display = "block";
      document.getElementById("mainUI").style.display = "none";
    }
  });

  function signUp() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        cred.user.sendEmailVerification().then(() => {
          alert("Verification email sent.");
        });
      }).catch(err => alert(err.message));
  }

  function signIn() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
  }

  function signOut() {
    auth.signOut();
  }

  function resetPassword() {
    const email = document.getElementById("email").value;
    auth.sendPasswordResetEmail(email).then(() => {
      alert("Password reset email sent.");
    }).catch(err => alert(err.message));
  }

  document.getElementById("gameIconInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      uploadedIconBase64 = evt.target.result;
    };
    reader.readAsDataURL(file);
  });

  function uploadGame() {
    const title = document.getElementById("gameTitle").value.trim();
    if (!title || !uploadedIconBase64) {
      alert("Please provide a title and icon.");
      return;
    }

    const uid = auth.currentUser.uid;
    const gameKey = db.ref().child("games").push().key;
    const gameData = {
      title: title,
      iconBase64: uploadedIconBase64
    };

    db.ref("games/" + uid + "/" + gameKey).set(gameData)
      .then(() => {
        document.getElementById("gameTitle").value = "";
        document.getElementById("gameIconInput").value = "";
        uploadedIconBase64 = "";
      });
  }

  function loadUserData(uid) {
    db.ref("users/" + uid + "/doodlebux").once("value").then(snap => {
      document.getElementById("doodleBux").textContent = snap.val() || 0;
    });

    db.ref("games/" + uid).on("value", snap => {
      const games = snap.val() || {};
      const gamesList = document.getElementById("gamesList");
      gamesList.innerHTML = "";

      for (let key in games) {
        const game = games[key];
        const li = document.createElement("li");
        li.textContent = game.title;
        const img = document.createElement("img");
        img.src = game.iconBase64;
        li.appendChild(document.createElement("br"));
        li.appendChild(img);
        gamesList.appendChild(li);
      }
    });

    db.ref("friends/" + uid).on("value", snap => {
      const friends = snap.val() || {};
      const list = document.getElementById("friendsList");
      list.innerHTML = "";
      for (let f in friends) {
        const li = document.createElement("li");
        li.textContent = friends[f];
        list.appendChild(li);
      }
    });

    db.ref("friendRequests/" + uid).on("value", snap => {
      const requests = snap.val() || {};
      const list = document.getElementById("friendRequestsList");
      list.innerHTML = "";
      for (let rid in requests) {
        const li = document.createElement("li");
        li.textContent = requests[rid];
        const btn = document.createElement("button");
        btn.textContent = "Accept";
        btn.onclick = () => acceptFriend(uid, rid, requests[rid]);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  }

  function acceptFriend(myUid, requesterUid, requesterEmail) {
    db.ref("friends/" + myUid + "/" + requesterUid).set(requesterEmail);
    db.ref("friends/" + requesterUid + "/" + myUid).set(auth.currentUser.email);
    db.ref("friendRequests/" + myUid + "/" + requesterUid).remove();
  }
</script>

</body>
</html>